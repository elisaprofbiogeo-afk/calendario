<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Horarios de clase</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f7f7f7; }
        h1 { color: #2c3e50; text-align: center; }
        table { 
            border-collapse: collapse; 
            width: 100%; 
            max-width: 900px; 
            margin: 20px auto; 
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 12px; 
            text-align: center; 
        }
        th { 
            background-color: #3498db; 
            color: white; 
            font-weight: bold;
        }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #e8f4f8; }
        .recreo {
            background-color: #f39c12 !important;
            color: white;
            font-weight: bold;
        }
        .horarios {
            background-color: #ecf0f1;
            font-weight: bold;
        }
        .fixed-slot {
            background-color: #95a5a6 !important;
            color: white;
            font-weight: bold;
            cursor: not-allowed;
        }
        .editable-slot {
            cursor: pointer;
            transition: background-color 0.2s;
            min-width: 80px;
            min-height: 32px;
            position: relative;
        }
        .editable-slot:hover {
            background-color: #d5e8f3 !important;
        }
        .editable-slot.editing {
            background: #fffbe6 !important;
        }
        .slot-input {
            width: 90%;
            padding: 4px;
            font-size: 14px;
        }
        .slot-btns {
            margin-top: 2px;
        }
        .slot-save, .slot-cancel {
            font-size: 12px;
            margin: 0 2px;
            padding: 2px 6px;
            border-radius: 3px;
            border: none;
            cursor: pointer;
        }
        .slot-save { background: #27ae60; color: #fff; }
        .slot-cancel { background: #aaa; color: #fff; }
        .week-selector {
            text-align: center;
            margin: 20px auto;
            max-width: 900px;
        }
        .week-selector button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 10px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 16px;
        }
        .week-selector button:hover {
            background-color: #2980b9;
        }
        .week-selector span {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin: 0 20px;
        }
    </style>
</head>
<body>
    <h1>Horarios de la semana</h1>
    <div class="week-selector">
        <button id="prevWeek">◀ Anterior</button>
        <span id="weekDisplay"></span>
        <button id="nextWeek">Siguiente ▶</button>
    </div>
    <table>
        <thead>
            <tr>
                <th>Horarios</th>
                <th>Lunes</th>
                <th>Martes</th>
                <th>Miércoles</th>
                <th>Jueves</th>
                <th>Viernes</th>
            </tr>
        </thead>
        <tbody id="scheduleBody">
            <tr>
                <td class="horarios">8h25 - 9h20</td>
                <td data-day="0" data-slot="8h25-9h20"></td>
                <td data-day="1" data-slot="8h25-9h20"></td>
                <td data-day="2" data-slot="8h25-9h20"></td>
                <td data-day="3" data-slot="8h25-9h20"></td>
                <td data-day="4" data-slot="8h25-9h20"></td>
            </tr>
            <tr>
                <td class="horarios">9h20 - 10h15</td>
                <td data-day="0" data-slot="9h20-10h15"></td>
                <td data-day="1" data-slot="9h20-10h15"></td>
                <td data-day="2" data-slot="9h20-10h15"></td>
                <td data-day="3" data-slot="9h20-10h15"></td>
                <td data-day="4" data-slot="9h20-10h15"></td>
            </tr>
            <tr>
                <td class="horarios">10h15 - 11h10</td>
                <td data-day="0" data-slot="10h15-11h10"></td>
                <td data-day="1" data-slot="10h15-11h10"></td>
                <td data-day="2" data-slot="10h15-11h10"></td>
                <td data-day="3" data-slot="10h15-11h10"></td>
                <td data-day="4" data-slot="10h15-11h10"></td>
            </tr>
            <tr class="recreo">
                <td>11h10 - 11h35</td>
                <td colspan="5">RECREO</td>
            </tr>
            <tr>
                <td class="horarios">11h35 - 12h30</td>
                <td data-day="0" data-slot="11h35-12h30"></td>
                <td data-day="1" data-slot="11h35-12h30"></td>
                <td data-day="2" data-slot="11h35-12h30"></td>
                <td data-day="3" data-slot="11h35-12h30"></td>
                <td data-day="4" data-slot="11h35-12h30"></td>
            </tr>
            <tr>
                <td class="horarios">12h30 - 13h25</td>
                <td data-day="0" data-slot="12h30-13h25"></td>
                <td data-day="1" data-slot="12h30-13h25"></td>
                <td data-day="2" data-slot="12h30-13h25"></td>
                <td data-day="3" data-slot="12h30-13h25"></td>
                <td data-day="4" data-slot="12h30-13h25"></td>
            </tr>
            <tr>
                <td class="horarios">13h25 - 14h20</td>
                <td data-day="0" data-slot="13h25-14h20"></td>
                <td data-day="1" data-slot="13h25-14h20"></td>
                <td data-day="2" data-slot="13h25-14h20"></td>
                <td data-day="3" data-slot="13h25-14h20"></td>
                <td data-day="4" data-slot="13h25-14h20"></td>
            </tr>
            <tr class="recreo">
                <td>14h20 - 14h35</td>
                <td colspan="5">RECREO</td>
            </tr>
            <tr>
                <td class="horarios">14h35 - 15h30</td>
                <td data-day="0" data-slot="14h35-15h30"></td>
                <td data-day="1" data-slot="14h35-15h30"></td>
                <td data-day="2" data-slot="14h35-15h30"></td>
                <td data-day="3" data-slot="14h35-15h30"></td>
                <td data-day="4" data-slot="14h35-15h30"></td>
            </tr>
        </tbody>
    </table>

    <script>

    let currentWeekOffset = 0;
    let fixedSlots = [];
    let weekReservations = [];
    let editingCell = null;

    // --- Lógica de fecha de admin.html adaptada ---
    // Devuelve el lunes de la semana ISO (week, year)

    // Devuelve el lunes de la semana mostrada según el offset
    function getMondayOfCurrentWeek() {
    const today = new Date();
    today.setHours(0,0,0,0);
    // getDay(): 0=domingo, 1=lunes, ..., 6=sábado
    let dayOfWeek = today.getDay();
    // ISO: lunes=1, ..., domingo=0; diff = days since Monday
    let diff = (dayOfWeek + 6) % 7;
    const monday = new Date(today);
    monday.setDate(today.getDate() - diff + currentWeekOffset * 7);
    monday.setHours(0,0,0,0);
    // Debug: mostrar el lunes calculado y el día actual
    console.log('DEBUG getMondayOfCurrentWeek:', {
        today: today.toISOString().slice(0,10),
        monday: monday.toISOString().slice(0,10),
        currentWeekOffset
    });
    return monday;
    }

    // Devuelve la fecha yyyy-mm-dd para la columna data-day
    function getDateForDay(day) {
    const monday = getMondayOfCurrentWeek();
    // Sumar días en local time
    const d = new Date(monday);
    d.setDate(monday.getDate() + parseInt(day, 10));
    d.setHours(0,0,0,0);
    // Devolver fecha local yyyy-mm-dd
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const dayStr = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${dayStr}`;
    }

    function formatDate(date) {
        // Si date es string tipo yyyy-mm-dd, parsear como local
        let d;
        if (typeof date === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(date)) {
            const [y, m, day] = date.split('-');
            d = new Date(Number(y), Number(m) - 1, Number(day));
        } else {
            d = new Date(date);
        }
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();
        return `${day}/${month}/${year}`;
    }

        async function loadFixedSlots() {
            try {
                const response = await fetch('/api/fixed-slots');
                fixedSlots = await response.json();
                updateSchedule();
            } catch (err) {
                console.error('Erreur lors du chargement des créneaux fixes:', err);
            }
        }



    function updateSchedule() {
        // Limpiar todas las celdas
        const cells = document.querySelectorAll('td[data-day][data-slot]');
        // Debug: mostrar todas las reservas de la semana
        console.log('DEBUG weekReservations:', JSON.stringify(weekReservations, null, 2));
        cells.forEach(cell => {
            const day = parseInt(cell.dataset.day);
            const slot = cell.dataset.slot;
            const cellDate = getDateForDay(day);
            // Debug: mostrar el mapeo de columna
            console.log('DEBUG updateSchedule cell:', { day, slot, cellDate });
            // ¿Es un slot fijo?
            const fixedSlot = fixedSlots.find(
                s => s.day_of_week === day && s.time_slot === slot
            );
            if (fixedSlot) {
                cell.textContent = fixedSlot.subject || 'FIXE';
                cell.className = 'fixed-slot';
                cell.onclick = null;
            } else {
                // Debug: mostrar la fecha de la celda y la reserva encontrada
                // Print all reservation dates for this slot
                const slotReservations = weekReservations.filter(r => r.time_slot === slot);
                console.log('DEBUG cell match:', {
                    cellDate,
                    slot,
                    slotReservations: slotReservations.map(r => r.date),
                    res: slotReservations.find(r => r.date === cellDate)
                });
                const res = slotReservations.find(r => r.date === cellDate);
                cell.className = 'editable-slot';
                let debugInfo = '';
                // Si quieres mostrar info de debug, descomenta abajo:
                // debugInfo = `<div style='font-size:10px;color:#888;'>${cellDate}</div>`;
                // if (res && res.text) {
                //     debugInfo += `<div style='font-size:10px;color:#c00;'>res: ${res.date} - ${res.text}</div>`;
                // }
                cell.innerHTML = (res && res.text ? `<span>${res.text}</span>` : '') + debugInfo;
                cell.onclick = () => {
                    startEdit(cell, day, slot, res ? res.text : '');
                };
            }
        });
    }

    function getCurrentYearWeek() {
    // Usar exactamente la misma lógica de getMondayOfCurrentWeek
    const today = new Date();
    today.setHours(0,0,0,0);
    let dayOfWeek = today.getDay();
    let diff = (dayOfWeek + 6) % 7;
    const monday = new Date(today);
    monday.setDate(today.getDate() - diff + currentWeekOffset * 7);
    monday.setHours(0,0,0,0);
    // Ahora obtener el año y semana ISO de ese lunes
    const year = monday.getFullYear();
    // Calcular el jueves de esa semana para obtener el año ISO
    const thursday = new Date(monday);
    thursday.setDate(monday.getDate() + 3);
    const isoYear = thursday.getFullYear();
    // Calcular el primer jueves del año ISO
    const firstThursday = new Date(isoYear, 0, 4);
    firstThursday.setDate(firstThursday.getDate() + 3 - ((firstThursday.getDay() + 6) % 7));
    const week = 1 + Math.round(((thursday - firstThursday) / 86400000) / 7);
    return { year: isoYear, week };
    }

    async function loadWeekReservations() {
        const { year, week } = getCurrentYearWeek();
        try {
            const response = await fetch(`/api/reservations?year=${year}&week=${week}`);
            const data = await response.json();
            // Filtrar solo reservas con time_slot válido y sumar un día a la fecha
            weekReservations = data
                .filter(r => r.time_slot)
                .map(r => {
                    let date = r.date || '';
                    if (/^\d{4}-\d{2}-\d{2}$/.test(date)) {
                        const d = new Date(date);
                        d.setDate(d.getDate() + 1);
                        const year = d.getFullYear();
                        const month = String(d.getMonth() + 1).padStart(2, '0');
                        const dayStr = String(d.getDate()).padStart(2, '0');
                        date = `${year}-${month}-${dayStr}`;
                    }
                    return {
                        date,
                        time_slot: r.time_slot,
                        text: r.name
                    };
                });
            updateSchedule();
        } catch (err) {
            weekReservations = [];
            updateSchedule();
        }
    }

        function startEdit(cell, day, slot, currentText) {
            if (editingCell) return;
            editingCell = cell;
            cell.classList.add('editing');
            cell.innerHTML = `<input class="slot-input" type="text" value="${currentText || ''}" maxlength="40" />
                <div class="slot-btns">
                    <button class="slot-save">OK</button>
                    <button class="slot-cancel">Annuler</button>
                    ${currentText ? '<button class="slot-delete" title="Borrar">✕</button>' : ''}
                </div>`;
            const input = cell.querySelector('.slot-input');
            input.focus();
            input.select();
            cell.querySelector('.slot-save').onclick = async (e) => {
                e.stopPropagation();
                await saveSlot(day, slot, input.value.trim());
            };
            cell.querySelector('.slot-cancel').onclick = (e) => {
                e.stopPropagation();
                cancelEdit();
            };
            const deleteBtn = cell.querySelector('.slot-delete');
            if (deleteBtn) {
                deleteBtn.onclick = async (e) => {
                    e.stopPropagation();
                    await saveSlot(day, slot, '');
                };
            }
            input.onkeydown = async (e) => {
                if (e.key === 'Enter') {
                    await saveSlot(day, slot, input.value.trim());
                } else if (e.key === 'Escape') {
                    cancelEdit();
                }
            };
        }

        async function saveSlot(day, slot, text) {
            // Usar la fecha exacta de la columna clicada
            const date = getDateForDay(day);
            console.log('DEBUG saveSlot:', { day, date, slot, text });
            if (!text) {
                await fetch('/api/reserve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date, time_slot: slot, _method: 'DELETE' })
                });
            } else {
                await fetch('/api/reserve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: text, date, time_slot: slot })
                });
            }
            editingCell = null;
            await loadWeekReservations();
        }

        function cancelEdit() {
            editingCell = null;
            updateSchedule();
        }

    function updateWeekDisplay() {
        // Mostrar la semana actual (lunes-viernes) usando hora local
        const monday = getMondayOfCurrentWeek();
        const friday = new Date(monday);
        friday.setDate(monday.getDate() + 4);

        const weekText = `Semana del ${formatDate(monday)} al ${formatDate(friday)}`;
        document.getElementById('weekDisplay').textContent = weekText;

        // Actualizar cabeceras de tabla con las fechas usando hora local
        const headers = document.querySelectorAll('thead th');
        const dayNames = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'];
        for (let i = 0; i < 5; i++) {
            const dayDate = new Date(monday);
            dayDate.setDate(monday.getDate() + i);
            headers[i + 1].textContent = `${dayNames[i]}\n${formatDate(dayDate)}`;
        }
        // Cargar reservas de la semana
        loadWeekReservations();
    }

        document.getElementById('prevWeek').addEventListener('click', () => {
            currentWeekOffset--;
            updateWeekDisplay();
        });

        document.getElementById('nextWeek').addEventListener('click', () => {
            currentWeekOffset++;
            updateWeekDisplay();
        });

        // Initialize
        loadFixedSlots();
        updateWeekDisplay();
    </script>
</body>
</html>
